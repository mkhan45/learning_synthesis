<html>
  <head>
    <title>Synthesis</title>
  </head>
  <body>
    <h1>FlashFill--</h1>
    <table id="tab">
      <tr>
        <th>Input</th>
        <th>Output</th>
      </tr>
      <tr>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
      </tr>
      <tr>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
      </tr>
      <tr>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
      </tr>
      <tr>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
      </tr>
      <tr>
        <td><input type="text" /></td>
        <td><input type="text" /></td>
      </tr>
    </table>
    <div>Program: <code id="program"></code></div>
    <button id="run">Run</button>
  </body>
  <script>
    async function run() {
      if (document.querySelector("#run").onclick == undefined) {
        document.querySelector("#run").onclick = run;
        return;
      }
      let tab = document.querySelector("#tab");
      let inps = [];
      let outs = [];
      let tests = [];
      for (let i = 0; i < tab.rows.length; i += 1) {
        let row = tab.rows[i];
        let inp = row.cells[0].childNodes[0].value;
        let out = row.cells[1].childNodes[0].value;
        if (inp == "" || inp == undefined) {
          continue;
        }

        tests.push(inp);
        if (out != "") {
          inps.push(inp);
          outs.push(out);
        }
      }
      console.log(inps, outs, tests);

      if (inps.length == 0) {
        return;
      }
      const worker = new Worker("/pkg/synthesizer.js");
      worker.postMessage({inps, outs, tests});
      const result = await Promise.race([
        new Promise((resolve) =>
          worker.addEventListener(
            "message",
            ({data}) => {
              resolve(data);
            },
            {
              once: true,
            }
          )
        ),
        new Promise((resolve) => {
          setTimeout(() => {
            console.log("timeout");
            resolve({error: true});
          }, 10_000);
        }),
      ]);
      worker.terminate();

      if (!result.error) {
        let program = result.get("program");
        let results = result.get("test_results");
        document.querySelector("#program").innerHTML = program;
        for (let i = 0; i < results.length; i += 1) {
          let row = tab.rows[i + 1];
          row.cells[1].childNodes[0].value = results[i];
        }
      } else {
        console.log("error :(");
        document.querySelector("#program").innerHTML = "An error occured :(";
      }
    }
    run();
  </script>
  <script type="not-a-module">
    import init, {synthesize} from "./pkg/synthesizer.js";
  </script>
</html>
